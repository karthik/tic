<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced usage • tic</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Advanced usage">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tic</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.2.13.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/tic.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/tic-advantages.html">tic advantages</a>
    </li>
    <li>
      <a href="../articles/tic-usethis-travis.html">tic, travis and usethis</a>
    </li>
    <li>
      <a href="../articles/advanced.html">Advanced usage</a>
    </li>
    <li>
      <a href="../articles/custom_steps.html">Custom steps</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ropenscilabs/tic">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Advanced usage</h1>
                        <h4 class="author">Patrick Schratz, Kirill Müller</h4>
            
            <h4 class="date">2018-07-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ropenscilabs/tic/blob/master/vignettes/advanced.Rmd"><code>vignettes/advanced.Rmd</code></a></small>
      <div class="hidden name"><code>advanced.Rmd</code></div>

    </div>

    
    
<div id="deployment" class="section level1">
<h1 class="hasAnchor">
<a href="#deployment" class="anchor"></a>Deployment</h1>
<div id="pkgdown-deployment" class="section level2">
<h2 class="hasAnchor">
<a href="#pkgdown-deployment" class="anchor"></a>pkgdown deployment</h2>
<p>You may optionally set the deployment to the <code>gh-pages</code> branch and then change the branch serving your site in the Github repo settings (change it to <code>gh-pages</code>). By this you do not have all the commits from Travis in your <code>master</code> branch but your <code>pkgdown</code> site will be silently updated in the backgroud without any disturbance. Simply set the <code>branch</code> argument to <code>gh-pages</code> and <code>orphan = TRUE</code> so that a force git push is initiated. Now, <code><a href="../reference/step_push_deploy.html">step_push_deploy(branch = "gh-pages", orphan = TRUE)</a></code> will deploy the resulting files of your <code>pkgdown</code> site to the <code>gh-pages</code> branch of your repo.</p>
</div>
<div id="committing-single-files" class="section level2">
<h2 class="hasAnchor">
<a href="#committing-single-files" class="anchor"></a>Committing single files</h2>
<p>Function <code><a href="../reference/step_push_deploy.html">step_push_deploy()</a></code> has the ability to only commit and push single files if they have changed during a CI build. This can be very useful for conditionally pushing documentation files like <code>NEWS</code> or <code>man/</code> and <code>NAMESPACE</code> if these are automatically created via Travis. Simply add the desired files to argument <code>commit_paths</code> in <code><a href="../reference/step_push_deploy.html">step_push_deploy()</a></code>.</p>
</div>
</div>
<div id="running-stages-conditionally" class="section level1">
<h1 class="hasAnchor">
<a href="#running-stages-conditionally" class="anchor"></a>Running stages conditionally</h1>
<p>If you run multiple Travis builds on every push (e.g. if you test on multiple R versions or if you are using “build stages” on Travis (i.e. multiple builds that start sequentially after each other)), you often need to condition the <code>tic</code> stages based on environment variables. The most common use case is the testing on multiple R versions.</p>
<p>Usually, <code>tic</code> initiates a code coverage testing in the <code>after_success</code> stage (see <code>?add_package_checks()</code>). Now you do not want that this is run on every R version as the outcome will always be the same. Furthermore, it might trigger problems when all coverages are pushed at roughly the same time. So, it is sufficient to just run it on one R version, e.g. “release”. When you use multiple R versions, Travis automatically sets up a build matrix with each build having <a href="https://docs.travis-ci.com/user/languages/r/#Environment-Variables">set an environmental variable for the R version</a> used. So all you need to do is to condition the stage execution on this env variable:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="cf">if</span> (<span class="kw">Sys.getenv</span>(<span class="st">"TRAVIS_R_VERSION"</span>) <span class="op">==</span><span class="st"> "release"</span>) {</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  <span class="kw"><a href="../reference/DSL.html">get_stage</a></span>(<span class="st">"after_success"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="st">    </span><span class="kw"><a href="../reference/DSL.html">add_step</a></span>(covr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/covr/topics/codecov">codecov</a></span>())</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">}</a></code></pre></div>
<p>Setting the <code>after_success</code> stage explicitly will overwrite what <code><a href="../reference/DSL.html">add_package_checks()</a></code> would trigger.</p>
<p>You may want to do the same for the deployment of the <code>pkgdown</code> site.</p>
</div>
<div id="installing-packages" class="section level1">
<h1 class="hasAnchor">
<a href="#installing-packages" class="anchor"></a>Installing packages</h1>
<div id="github-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#github-packages" class="anchor"></a>Github packages</h2>
<p>While Github packages can be installed by directly specyifing them in the <code>.travis.yml</code> file, its better to do it in <code>tic.R</code>. Sometimes the specification in <code>.travis.yml</code> is not run; this often happens when build matrices are used. Also, you want to set the command once to trigger in on all CI-systems. Github packages should be installed in the <code>install</code> stage:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="../reference/DSL.html">get_stage</a></span>(<span class="st">"install"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/DSL.html">add_code_step</a></span>(devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"r-lib/rcmdcheck"</span>))</a></code></pre></div>
</div>
<div id="cran-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#cran-packages" class="anchor"></a>CRAN packages</h2>
<p>Sometimes you need to install CRAN packages that are not specified in the DESCRIPTION file of your package. For example, to create a favicon in <code>pkgdown</code>, the <code>magick</code> package is required. To install the package only if it does not exist in the cache, run the following:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="../reference/DSL.html">get_stage</a></span>(<span class="st">"install"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="../reference/DSL.html">add_code_step</a></span>(<span class="cf">if</span> (<span class="kw">length</span>(<span class="kw">find.package</span>(<span class="st">"magick"</span>, <span class="dt">quiet =</span> <span class="ot">TRUE</span>)) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="kw">install.packages</span>(<span class="st">"magick"</span>))</a></code></pre></div>
</div>
</div>
<div id="using-travis-ci-meta-information" class="section level1">
<h1 class="hasAnchor">
<a href="#using-travis-ci-meta-information" class="anchor"></a>Using Travis CI Meta-information</h1>
<p>The <code><a href="../reference/ci.html">ci()</a></code> function holds valuable information about the used CI system. It can be used to query information that can be used for conditioning stages or steps.</p>
<p>For example, the user can make the deployment only to be run on Travis by using <code>inherits(ci(), "TravisCI")</code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="cf">if</span> (<span class="kw">inherits</span>(<span class="kw"><a href="../reference/ci.html">ci</a></span>(), <span class="st">"TravisCI"</span>)) {</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">  <span class="kw"><a href="../reference/DSL.html">get_stage</a></span>(<span class="st">"before_deploy"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="st">    </span><span class="kw"><a href="../reference/DSL.html">add_step</a></span>(<span class="kw"><a href="../reference/step_setup_ssh.html">step_setup_ssh</a></span>())</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">  <span class="kw"><a href="../reference/DSL.html">get_stage</a></span>(<span class="st">"deploy"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="st">    </span><span class="kw"><a href="../reference/DSL.html">add_step</a></span>(<span class="kw"><a href="../reference/step_push_deploy.html">step_push_deploy</a></span>())</a>
<a class="sourceLine" id="cb4-7" data-line-number="7">}</a></code></pre></div>
<p>See <code><a href="../reference/ci.html">?ci</a></code> for more information on which information can be extracted from this function.</p>
</div>
<div id="troubleshooting-running-tic-locally" class="section level1">
<h1 class="hasAnchor">
<a href="#troubleshooting-running-tic-locally" class="anchor"></a>Troubleshooting: Running tic locally</h1>
<p>You can run <code>tic</code> locally by using <code><a href="../reference/load_from_file.html">load_from_file()</a></code>. This function sources your <code>tic.R</code> file and reports eventual problems.</p>
</div>
<div id="troubleshooting-entering-the-ci-build" class="section level1">
<h1 class="hasAnchor">
<a href="#troubleshooting-entering-the-ci-build" class="anchor"></a>Troubleshooting: Entering the CI build</h1>
<p>If your Travis build fails and you have no clue why (error messages are too unspecific, you cannot reproduce the problem locally), you can enter into the Travis build via <code>ssh</code>. To do so, your repository must be <a href="https://docs.travis-ci.com/user/running-build-in-debug-mode/#enabling-debug-mode">opt-in</a> for “ssh debugging”.</p>
<p>Aftewards, you can call the following shell script locally by replacing <code>&lt;id&gt;</code> with the Travis job ID (you find it in the first lines of each build) and <code>&lt;token&gt;</code> with your Travis API token (you can find it in your Travis profile page).</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" data-line-number="1">$ <span class="ex">curl</span> -s -X POST \</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  -H <span class="st">"Content-Type: application/json"</span> \</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  -H <span class="st">"Accept: application/json"</span> \</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  -H <span class="st">"Travis-API-Version: 3"</span> \</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  -H <span class="st">"Authorization: token &lt;token&gt;"</span> \</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  -d <span class="st">"{</span><span class="dt">\"</span><span class="st">quiet</span><span class="dt">\"</span><span class="st">: true}"</span> \</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">  https://api.travis-ci.com/job/$<span class="op">&lt;</span>id<span class="op">&gt;</span>/debug</a></code></pre></div>
<p>After executing the script, the build will restart. Wait a few minutes until the build arrives at the point when it prints you the <code>ssh</code> command you can use to log in. It should look similar to <code>ssh ukjiuCEkxBBnRAe32Y8xCH0zj@ny2.tmate.io</code>.</p>
<p>Once you are in the buildm <a href="https://docs.travis-ci.com/user/running-build-in-debug-mode/#Things-to-do-once-you-are-inside-the-debug-VM">check</a> these handy functions to execute specific stages.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#deployment">Deployment</a><ul class="nav nav-pills nav-stacked">
<li><a href="#pkgdown-deployment">pkgdown deployment</a></li>
      <li><a href="#committing-single-files">Committing single files</a></li>
      </ul>
</li>
      <li><a href="#running-stages-conditionally">Running stages conditionally</a></li>
      <li>
<a href="#installing-packages">Installing packages</a><ul class="nav nav-pills nav-stacked">
<li><a href="#github-packages">Github packages</a></li>
      <li><a href="#cran-packages">CRAN packages</a></li>
      </ul>
</li>
      <li><a href="#using-travis-ci-meta-information">Using Travis CI Meta-information</a></li>
      <li><a href="#troubleshooting-running-tic-locally">Troubleshooting: Running tic locally</a></li>
      <li><a href="#troubleshooting-entering-the-ci-build">Troubleshooting: Entering the CI build</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Kirill Müller, Mika Braginsky, Karthik Ram, Jeroen Ooms, Patrick Schratz, rOpenSci.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
